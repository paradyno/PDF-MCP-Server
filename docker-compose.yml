# Common settings for development services
x-dev-common: &dev-common
  image: pdf-mcp-server-dev:latest
  build:
    context: .
    dockerfile: Dockerfile
    target: dev
  volumes:
    - .:/app
    - cargo-cache:/usr/local/cargo/registry
    - target-cache:/app/target
  working_dir: /app
  environment:
    - CARGO_HOME=/usr/local/cargo
    - PDFIUM_PATH=/opt/pdfium
    - RUST_BACKTRACE=1

services:
  dev:
    <<: *dev-common
    profiles: ["dev"]
    stdin_open: true
    tty: true

  # Run tests
  test:
    <<: *dev-common
    profiles: ["dev"]
    command: cargo nextest run

  # Run tests with coverage
  coverage:
    <<: *dev-common
    profiles: ["dev"]
    command: cargo llvm-cov --html --output-dir coverage

  # Format check
  fmt:
    <<: *dev-common
    profiles: ["dev"]
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
    command: cargo fmt --all -- --check

  # Lint
  clippy:
    <<: *dev-common
    profiles: ["dev"]
    command: cargo clippy --all-targets --all-features -- -D warnings

  # Performance benchmarks
  bench:
    <<: *dev-common
    profiles: ["dev"]
    command: cargo bench

  # Production runtime
  production:
    profiles: ["prod"]
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    environment:
      - PDFIUM_PATH=/opt/pdfium
      - RUST_BACKTRACE=1

volumes:
  cargo-cache:
  target-cache:
